# ç”µèµ›101 å…¥é—¨ç‰ˆ

*æœ¬æ–‡ä½œè€…æ°´å¹³æœ‰é™ï¼Œç¤¾ç•œåŠ ç­å¤§è„‘é€€åŒ–ï¼Œå¯èƒ½å‡ºç°ç¬”è¯¯æˆ–äº‹å®é”™è¯¯ï¼Œè¯·è¯»è€…è°…è§£*

*æœ¬æ–‡é‡‡ç”¨ [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/legalcode.txt)åè®®*

*åˆ›å»ºæ—¶é—´: 2024/10/01 ğŸ‚*


*ä½œè€…: nmpassthf nmpassthf@gmail.com*

åœ¨ç”µèµ›ä¸­ï¼ŒåŒå­¦ä»¬éœ€è¦ç¼–å†™çš„è½¯ä»¶å¤§éƒ¨åˆ†æ˜¯é¢å‘**ä½åŠŸè€—Arm**èŠ¯ç‰‡çš„ï¼Œæ‰€ä»¥æœ¬æ•™ç¨‹å°†ä»¥ **STM32G431** è¿™æ¬¾èŠ¯ç‰‡ä¸ºæ ·ä¾‹ï¼Œå‘åŒå­¦ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹å¦‚ä½•å®‰è£…æ‰€éœ€çš„å¼€æºå·¥å…·å¹¶è‡ªå·±åŠ¨æ‰‹ç¼–å†™ä¸€ä¸ªåµŒå…¥å¼ç¨‹åºã€‚

------

[TOC]

------

## Chap 0 ä»€ä¹ˆæ˜¯åµŒå…¥å¼ç¨‹åºï¼Ÿ

ä¼—æ‰€å‘¨çŸ¥ï¼Œä»¥**Cè¯­è¨€**ä¸ºä¾‹ï¼Œæ„å»ºä¸€ä¸ªå¯ä»¥åœ¨æ¡Œé¢ç¯å¢ƒä¸­å¯ä»¥è¿è¡Œçš„ç¨‹åºçš„åŸºæœ¬æ­¥éª¤ä¸º: **ç¼–å†™Source-ç¼–è¯‘-é“¾æ¥-è¿è¡Œ-(è°ƒè¯•)** 

åœ¨åµŒå…¥å¼ç¯å¢ƒä¸­ï¼Œæµç¨‹ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡å’Œæˆ‘ä»¬ä¹‹å‰æ‰€å­¦åˆ°çš„ç¨‹åºæœ‰äº›è®¸å¼‚åŒ: 

1ã€è¿è¡Œç¯å¢ƒ: **åµŒå…¥å¼ç¨‹åºé€šå¸¸æ˜¯ä¸€ä¸ªè£¸æœºç¨‹åºï¼Œæˆ–è¿è¡Œåœ¨å®æ—¶æ“ä½œç³»ç»Ÿä¸­**

å› æ­¤ï¼Œé€šå¸¸**ä¸æ¨è**ä¸€ä¸ªåµŒå…¥å¼ç¨‹åºä½¿ç”¨å †å†…å­˜ã€‚è¿™æ˜¯ç”±äº: 

- é€šå¸¸æƒ…å†µä¸‹åµŒå…¥å¼ç¯å¢ƒä¸­çš„è®¤ä¸ºåˆ’åˆ†ç»™å †çš„å†…å­˜æ¯”è¾ƒå°‘ã€‚
- ä¸€æ—¦å‡ºç°å†…å­˜æ³„æ¼å‡ ä¹æ²¡æœ‰æ“ä½œç³»ç»Ÿå…œåº•ã€‚
- å¼•å…¥å †å†…å­˜ä¼šæå¤§åœ°é™ä½ç¨‹åºçš„é²æ£’æ€§ï¼Œå¹¶æé«˜è½¯ä»¶éƒ¨åˆ†çš„å¤æ‚åº¦ã€‚

2ã€ç¡¬ä»¶ç¯å¢ƒ: **åµŒå…¥å¼ç¨‹åºé€šå¸¸è¿è¡Œåœ¨MCUä¸­ï¼Œé€šè¿‡GPIOã€ADCã€DACç­‰ç‰©ç†å¤–è®¾å®ç°å„ç±»åŠŸèƒ½**

å› æ­¤ï¼Œä¸€ä¸ªåµŒå…¥å¼ç¨‹åºçš„ç¨‹åºæœ¬èº«çš„å¤§å°å’Œè¿è¡Œæ—¶å¤§å°å°†å—é™äºMCUå†…ç½®çš„flashå¤§å°å’Œæ‰©å±•çš„flashã€sdramå­˜å‚¨å®¹é‡ã€‚åœ¨åˆ†é…æ ˆå˜é‡å’Œå…¨å±€å˜é‡çš„æ—¶å€™éœ€è¦ç‰¹åˆ«æ³¨æ„å†…å­˜çš„å ç”¨é—®é¢˜ã€‚

åŒæ—¶ï¼Œè¿‘ä¹æ‰€æœ‰å¤–è®¾éƒ½éœ€è¦ç¨‹åºå‘˜é€šè¿‡å†™å¯„å­˜å™¨ç­‰æ–¹å¼**è‡ªè¡Œåˆå§‹åŒ–**ã€‚

åˆå§‹åŒ–å¤–è®¾ï¼Œå¹¶ä¸ºå„ç§å¤–è®¾ç¼–å†™ç¨‹åºå°±æ˜¯åµŒå…¥å¼ç¨‹åºä¸»è¦çš„å†…å®¹ã€‚

3ã€ç¼–è¯‘ç¯å¢ƒ: åµŒå…¥å¼ç¨‹åºçš„**åº•å±‚CPUæ¶æ„**ï¼ˆARM Cortex-Mä¹‹ç±»çš„ï¼‰é€šå¸¸ä¸ä½ ç¼–å†™ç¨‹åºçš„ç¯å¢ƒï¼ˆx86_64ã€AArch64ï¼‰**ä¸ä¸€è‡´**

å› æ­¤ï¼Œä¸ºäº†ç¼–è¯‘å¹¶è°ƒè¯•å¼‚æ„ç¨‹åºï¼Œæˆ‘ä»¬æ‰éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„å·¥å…·é“¾**äº¤å‰ç¼–è¯‘**: åœ¨æœ¬æœºçš„æ¶æ„ä¸­ç¼–å†™ã€ç¼–è¯‘ã€é“¾æ¥å…¶ä»–æ¶æ„çš„ç¨‹åºã€‚

4ã€çƒ§å½•å’Œè°ƒè¯•: 

ç”±äºåµŒå…¥å¼MCUé€šå¸¸ä½¿ç”¨å†…ç½®çš„SRAMã€flashä½œä¸ºå­˜å‚¨å•å…ƒï¼Œå› æ­¤ç¼–è¯‘å¥½çš„ç¨‹åºä¹Ÿéœ€è¦ä½¿ç”¨å¯¹åº”çš„ç¡¬ä»¶çƒ§å½•å™¨å°†ç¨‹åºå†™å…¥åˆ°èŠ¯ç‰‡å†…éƒ¨ä¸­ã€‚

å¸¸è§çš„è°ƒè¯•å™¨åŒæ—¶ä¹Ÿå…·å¤‡çƒ§å½•çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚STçš„ST-LINK/V2ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¡¬ä»¶è°ƒè¯•å™¨æ¥çƒ§å½•ç¨‹åºæˆ–è€…è®©GDB detachåˆ°åµŒå…¥å¼çš„ç¨‹åºä¸­æ‰“æ–­ç‚¹è°ƒè¯•ã€‚

## Chap 1 ç¼–å†™-ç¼–è¯‘-çƒ§å½•-è°ƒè¯• æ‰€éœ€çš„å·¥å…·

### Chap 1.1 å·¥å…·é“¾ç®€ä»‹

åœ¨æ­¤æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä½¿ç”¨**VSCode + CubeMX + XMake (GNU make)+ Arm-none-eabi-GCC + OpenOCD**å·¥å…·æ¥æ„å»ºä¸€ä¸ªåµŒå…¥å¼å·¥ç¨‹ã€‚

åœ¨æ­¤ï¼Œä¸å¯¹è¿™äº›å¼€æºå·¥å…·åšè¿‡å¤šæ•™ç¨‹ï¼Œè¿™äº›å·¥å…·çš„å®˜ç½‘éƒ½æœ‰å¾ˆè¯¦ç»†çš„æ–‡æ¡£ï¼Œå¤§å®¶å¯ä»¥å…ˆæŒ‰ç…§æˆ‘çš„é…ç½®è¿‡ç¨‹ç¨åŠ æ”¹åŠ¨ï¼Œé€‚åº”è‡ªå·±çš„å¼€å‘æ¿å³å¯ã€‚

åœ¨è¿™ä¸²å·¥å…·ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨: 

- **VSCode**: ç¼–è¾‘ã€æµè§ˆã€è°ƒè¯•ä»£ç ã€‚

- **CubeMX**: åˆ›å»ºå·¥ç¨‹å¹¶å¤åˆ¶æ‰€éœ€çš„HALï¼ˆæˆ–è€…LLï¼‰åº“åˆ°æˆ‘ä»¬çš„å·¥ç¨‹è·¯å¾„ï¼Œå¹¶ç”Ÿæˆæˆ‘ä»¬æ‰€éœ€çš„é“¾æ¥è„šæœ¬å’Œå¯åŠ¨æ±‡ç¼–ã€‚

- **äº¤å‰ç¼–è¯‘å™¨**: ARMå‘è¡Œçš„**arm-none-eabi-gcc**ã€‚

- **OpenOCD**: å°†ç”Ÿæˆçš„hexæ–‡ä»¶çƒ§å½•åˆ°ç›®æ ‡å•ç‰‡æœºã€‚

- **OpenOCD+GDB**: è¿œç¨‹è°ƒè¯•åµŒå…¥å¼ç¨‹åºã€‚

å¯é€‰é¡¹: 

- **Git**: ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶ï¼Œæ–¹ä¾¿ç®¡ç†æºç çš„ç‰ˆæœ¬ã€‚

### Chap 1.2 è‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶

å¯¹äºä¸€ä¸ªæºæ–‡ä»¶ä¼—å¤šçš„å¤§å‹åº”ç”¨æ¥è¯´ï¼Œä½¿ç”¨è¿™ç±»è‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶å¯ä»¥æå¤§åœ°å‡å°‘ç¼–è¯‘æ—¶çš„å·¥ä½œé‡ï¼Œå¹¶åŠ å¿«ç¼–è¯‘é€Ÿåº¦ã€‚å¯¹äºC/C++è¯­è¨€æ„å»ºçš„é¡¹ç›®æ¥è¯´ï¼ŒXMakeã€CMakeå’ŒGNU makeç­‰ä¸€ä¼—è½¯ä»¶éƒ½å¯ä»¥å®ç°æ­¤åŠŸèƒ½ã€‚

å› ä¸ºé€‰æ‹©ä¸åŒçš„è‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶ä¼š**å½±å“åˆ°æ¥ä¸‹æ¥é…ç½®VSCodeç¼–è¾‘å™¨çš„æ’ä»¶**ï¼Œå› æ­¤æœ¬æ–‡åˆ—å‡ºäº†ä¸¤ç±»åŒºåˆ«è¾ƒå¤§çš„è‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶ã€‚

**å¯ä»¥æ ¹æ®è‡ªèº«å–œå¥½é€‰æ‹©å…¶ä¸€ä½¿ç”¨**

[Chap3](#chap-3-ä½¿ç”¨xmake--clangd-intellisense) ä¸­å°†è¯¦ç»†ä»‹ç»åŸºäºXMakeå·¥å…·çš„é…ç½®æ–¹æ³•ã€‚

[Chap4](#chap-4-ä½¿ç”¨GNU-make--microsoft-cc-intellisense) ä¸­å°†è¯¦ç»†ä»‹ç»åŸºäºGNU makeå·¥å…·çš„é…ç½®æ–¹æ³•ã€‚

### Chap 1.3 å®‰è£…å‰çŸ¥è¯†ç‚¹

#### Chap 1.3.1 ç¯å¢ƒå˜é‡

æŒ‡çš„æ˜¯å°†æŸä¸€ä¸ªå¯ä»¥è¿è¡Œçš„å¯æ‰§è¡Œç¨‹åºçš„**ç›®å½•**æ·»åŠ è¿›æ“ä½œç³»ç»Ÿçš„Pathæœç´¢ç›®å½•ä¸­ã€‚

ï¼ˆe.g. å°†ä½äº`C:\ENV\openocd\bin\openocd.exe` çš„**openocdå¯æ‰§è¡Œç¨‹åº**åŠ å…¥pathï¼Œè¯·å°†`C:\ENV\openocd\bin`è¿½åŠ å†™å…¥**Path**ä¸­ï¼‰

åœ¨Windows 11çš„æ“ä½œæµç¨‹ä¸º: 

![1.3.1.1](./Assets/Sc/1.3.1.1.png)

![1.3.1.2](./Assets/Sc/1.3.1.2.png)

Linux ä¸‹å¯ä»¥é€šè¿‡å‘ `/etc/profile.d/`ä¸‹æ–°å¢profileæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ·»åŠ ç¯å¢ƒå˜é‡ã€‚

```sh
export PATH='$PATH:/usr/local/openocd/bin'
```

#### Chap 1.3.2 å–„ç”¨äº’è”ç½‘

å¾ˆå¤šé—®é¢˜éƒ½å¯ä»¥åœ¨ç½‘ä¸Šè·å–åˆ°ç­”æ¡ˆã€‚

ç¼–ç¨‹ç±»é—®é¢˜: æ¨èä½¿ç”¨è‹±æ–‡åœ¨Googleç­‰æœç´¢å¼•æ“ä¸­æ£€ç´¢ï¼Œè¿™æ¯”ç•™è¨€æé—®é«˜æ•ˆçš„å¤š ã€‚

ç¼–è¯‘å‚æ•°/è½¯ä»¶é€‰é¡¹/ä½¿ç”¨æ–‡æ¡£: æ¨èæŸ¥è¯¢å¯¹åº”è½¯ä»¶çš„å®˜ç½‘ï¼Œéƒ½ä¼šæ•´ç†å‡ºDocumentæˆ–Manualï¼ˆæ³¨æ„ç‰ˆæœ¬å·ï¼‰ã€‚

e.g. [GNU Make Manual](https://www.gnu.org/software/make/manual/make.html)

## Chap 2 åŸºç¡€ç»„ä»¶å®‰è£…

æœ¬æ–‡ä¸­ï¼Œé»˜è®¤è¯»è€…ä½¿ç”¨æœ€æ–°çš„x86_64æ¶æ„çš„Windows 10/11 64bitæ“ä½œç³»ç»Ÿã€‚

*å¯¹äºä½¿ç”¨Ubuntuæˆ–Fedoraç­‰Linuxç³»ç»Ÿçš„è¯»è€…ï¼Œå¯ä»¥é€šè¿‡åŒ…ç®¡ç†å™¨ç®€åŒ–å®‰è£…çš„æ­¥éª¤ï¼›éƒ¨åˆ†é…ç½®é¡¹å’Œè·¯å¾„å¯èƒ½ä¸æ–‡ä¸­æ‰€åˆ—ä¸åŒã€‚*

*å¦‚æœä½ æ˜¯æ²¡æœ‰ä½¿ç”¨Linuxç»éªŒçš„**å°ç™½**ï¼Œæœ¬èŠ‚ä¸­æ‰€åˆ—å‡ºçš„bashå‘½ä»¤æ¨èä½¿ç”¨**å¤åˆ¶é»è´´**çš„å½¢å¼æ‰§è¡Œï¼Œé¿å…å‡ºç°æ‹¼å†™é”™è¯¯*

***æ–‡ä¸­å¤§éƒ¨åˆ†å·¥å…·ä½¿ç”¨é»˜è®¤å®‰è£…è·¯å¾„ï¼Œè¯·æ³¨æ„æ ¸å¯¹ä½ è‡ªå·±çš„æ–‡ä»¶è·¯å¾„***

### Chap 2.1 STM32CubeMX

STM32CubeMXæ˜¯STå…¬å¸æ¨å‡ºçš„ä¸€ä¸ªè‡ªåŠ¨åŒ–ä»£ç ç”Ÿæˆå™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤å·¥å…·ä¾¿åˆ©çš„ä¸‹è½½åˆ°STçš„MCUçš„ç›¸å…³å¼€å‘SDKã€é…ç½®MCUç›¸å…³å‚æ•°å¹¶è‡ªåŠ¨ç”Ÿæˆå·¥ç¨‹ã€‚

æˆ‘ä»¬å¯ä»¥ä»STçš„å®˜ç½‘è·å–æ­¤è½¯ä»¶: [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html)ã€‚

åœ¨å®˜ç½‘ä¸‹è½½å¹¶å®‰è£…å³å¯ã€‚

### Chap 2.2 MSYS2

> æœ¬ç« èŠ‚å‚è€ƒäº†[MSYS2 Installer](https://www.msys2.org/docs/installer/)

è€ƒè™‘åˆ°æˆ‘ä»¬å¯èƒ½ä½¿ç”¨GNUå·¥å…·é“¾(GNU Make/GCCç­‰å·¥å…·)ï¼Œè·å–å…¶æœ€ä¾¿åˆ©çš„æ–¹å¼æ˜¯é€šè¿‡MSYS2çš„pacmanåŒ…ç®¡ç†å™¨å®‰è£…è¿™äº›å·¥å…·ã€‚

MSYS2æ˜¯ä¸€ä¸ªå·¥å…·å’Œåº“çš„é›†åˆï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåŸºäºå¼€æºè½¯ä»¶çš„æœ¬åœ°æ„å»ºç¯å¢ƒï¼Œç”¨äºæ„å»ºã€å®‰è£…å’Œè¿è¡Œæœ¬åœ° Windows è½¯ä»¶ã€‚

MSYS2 Installerå¯ä»¥ä»[MSYS2 Installer distrib](https://repo.msys2.org/distrib/) æˆ–å…¶ Githubä»“åº“è·å–ã€‚

ä¸‹è½½å…¶ä¸­çš„ `msys2-x86_64-latest.exe`ç„¶åä½¿ç”¨: 

```cmd
.\msys2-x86_64-latest.exe in --confirm-command --accept-messages --root C:/msys64
```

å®‰è£…MSYS2åˆ°é»˜è®¤è·¯å¾„: `C:/msys64`ä¸­ã€‚

å®‰è£…ç»“æŸååœ¨msys2 MINGW64 bashä¸­ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ›´æ–°MSYS2: 

```sh
pacman -Syyuu
```

bashé‡å¯ä¹‹åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åŒæ­¥å¹¶æ›´æ–°å‰©ä½™è½¯ä»¶åŒ…: 

```sh
pacman -Suu
```

æœ€åå°†msys2 MINGW64çš„binç›®å½•æ·»åŠ åˆ°windowsçš„Pathä¸­å³å¯ã€‚

> e.g. ä»¥é»˜è®¤å®‰è£…åˆ°`C:\msys64\`ç›®å½•çš„MSYS2ä¸ºä¾‹:
>
> åº”è¯¥å°†`C:\msys64\mingw64\bin`æ·»åŠ åˆ°Windowsçš„Pathä¸­ã€‚

### Chap 2.3 GCC

å¦‚å‰å‡ èŠ‚æ‰€è¿°ï¼Œç”±äºæˆ‘ä»¬éœ€è¦ä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨ï¼Œå› æ­¤éœ€è¦è·å–arm-none-eabi-gccç¼–è¯‘å™¨ã€‚

arm-none-eabi-gccçš„åå­—ä»£è¡¨: 

- arm: å®ƒç¼–è¯‘çš„targetæ˜¯armæ¶æ„çš„
- none: æ²¡æœ‰ç›®æ ‡æ“ä½œç³»ç»Ÿ
- eabi: åµŒå…¥å¼ABI
- gcc: GCC

åœ¨msys2 MINGW64 bashä¸­ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…arm-none-eabi-gcc

```sh
pacman -S mingw-w64-x86_64-arm-none-eabi-gcc
```

### Chap 2.4 OpenOCD

åœ¨msys2 MINGW64 bashä¸­ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…openocd

```sh
pacman -S mingw-w64-x86_64-openocd
```

### Chap 2.5 Git

> æœ¬ç« èŠ‚å‚è€ƒäº† [Install inside MSYS2 proper](https://github.com/git-for-windows/git/wiki/Install-inside-MSYS2-proper)

1. æ·»åŠ git-for-windowsçš„è½¯ä»¶æº:

   1. å¤‡ä»½/etc/pacman.conf

      ```sh
      \cp /etc/pacman.conf /etc/pacman.conf.bak
      ```

   2. åœ¨msys2 MINGW64 çš„bashä¸­æ‰§è¡Œ

      ```sh
      sed -i '/^\[mingw32\]/{ s|^|[git-for-windows]\nServer = https://wingit.blob.core.windows.net/x86-64\n\n[git-for-windows-mingw32]\nServer = https://wingit.blob.core.windows.net/i686\n\n|; }' /etc/pacman.conf
      ```

2. æ›´æ–°ç­¾å:

   åœ¨bashä¸­æ‰§è¡Œ

   ```sh
   rm -r /etc/pacman.d/gnupg/
   pacman-key --init
   pacman-key --populate msys2
   ```

3. ä½¿ç”¨git-for-windowsçš„GPGæ›´æ–°ç­¾å:

   ```sh
   curl -L https://raw.githubusercontent.com/git-for-windows/build-extra/HEAD/git-for-windows-keyring/git-for-windows.gpg | pacman-key --add - && pacman-key --lsign-key E8325679DFFF09668AD8D7B67115A57376871B1C && pacman-key --lsign-key 3B6D86A1BA7701CD0F23AED888138B9E1A9F3986
   ```

4. æ›´æ–°è½¯ä»¶ä»“:  `pacman -Syyuu`

5. æ›´æ–°ç»“æŸé‡å¯bashåç»§ç»­æ›´æ–°å‰©ä½™åŒ…:  `pacman -Suu`

6. å®‰è£…git-for-windows:

   ```sh
   pacman -S mingw-w64-x86_64-{git,git-doc-html,git-doc-man} mingw-w64-x86_64-git-extra
   ```

### Chap 2.6 éªŒè¯å¦‚ä¸Šå®‰è£…

å¦‚æœä½ æ­£ç¡®çš„å®‰è£…äº†ä»¥ä¸ŠåŒ…ï¼Œå¹¶ä¸”æ­£ç¡®çš„å°†MSYS2 mingw64çš„`bin/`ç›®å½•æ·»åŠ åˆ°äº†Pathï¼Œé‚£ä¹ˆéµä»ä¸€ä¸‹æ“ä½œ: 

- æ‰“å¼€windows CMD

- è¾“å…¥`arm-none-eabi-gcc -v`å‘½ä»¤

  â€‹	ä½ å°†çœ‹åˆ°CMDæ­£ç¡®çš„æ‰“å°å‡ºæ¥äº†gccçš„ç¼–è¯‘é€‰é¡¹å’Œgccçš„ç‰ˆæœ¬å·

- è¾“å…¥`openocd -v`å‘½ä»¤

  â€‹	ä½ å°†çœ‹åˆ°CMDæ­£ç¡®çš„æ‰“å°å‡ºæ¥äº†Open On-Chip Debuggerçš„ç‰ˆæœ¬å·

- è¾“å…¥`git -v`å‘½ä»¤

  â€‹	ä½ å°†çœ‹åˆ°CMDæ­£ç¡®çš„æ‰“å°å‡ºæ¥äº†gitçš„ç‰ˆæœ¬å·

å¦‚æœä½ çš„æ¯ä¸€æ¡å‘½ä»¤éƒ½æç¤º`â€™arm-none-eabi-gccâ€™ ä¸æ˜¯å†…éƒ¨æˆ–å¤–éƒ¨å‘½ä»¤ï¼Œä¹Ÿä¸æ˜¯å¯è¿è¡Œçš„ç¨‹åº`ä¹‹ç±»çš„æŠ¥é”™ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä½ æ²¡æœ‰æ­£ç¡®çš„æ·»åŠ `bin/`ç›®å½•åˆ°Pathä¸­ã€‚

å¦‚æœæŸä¸€æ¡å‘½ä»¤æŠ¥é”™ï¼Œåˆ™å¯èƒ½ä½ å¯¹åº”çš„è½¯ä»¶åŒ…å®‰è£…æœ‰é—®é¢˜ï¼Œå¯ä»¥å°è¯•ä»é‡æ–°ä½¿ç”¨pacmanå®‰è£…ã€‚

## Chap 3 ä½¿ç”¨XMake + clangd IntelliSense

*ç« èŠ‚æç¤º: Chap 3 å’Œ Chap 4é€‰æ‹©å…¶ä¸€å³å¯*

*ä¸ªäººè®¤ä¸ºç›®å‰ä½¿ç”¨ä½“éªŒæœ€ä½³ã€å“åº”é€Ÿåº¦å‰åˆ—ã€å…·å¤‡å¼ºå¤§é™æ€æ£€æŸ¥åŠŸèƒ½çš„å·¥å…·ç»„åˆ*

*clangdçš„é™æ€æ£€æŸ¥ç›¸å…³çš„é…ç½®ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»äº†*

### Chap 3.1 XMakeå’Œclangdå®‰è£…

åœ¨msys2 MINGW64 bashä¸­ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…clangd:

```sh
pacman -S mingw-w64-x86_64-{clang,clang-tools-extra}
```

å®‰è£…å®Œæˆåï¼Œåœ¨bashä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤:

```sh
clangd --version
```

å¯çœ‹åˆ°clangdæ‰“å°è‡ªèº«çš„ç‰ˆæœ¬å·ã€‚

è®¿é—®xmakeçš„å®˜ç½‘ [xmake.io](https://xmake.io) å¹¶æ ¹æ®installationä¸€èŠ‚ç»™å‡ºçš„æ•™ç¨‹ä¸‹è½½å®‰è£…åŒ…å®‰è£…å³å¯ã€‚

> note: å¦‚æœé€šè¿‡pacmanå‘½ä»¤`pacman -Sy mingw-w64-x86_64-xmake`å®‰è£…
>
> åˆ™éœ€è¦åœ¨Windows Pathä¸­æ·»åŠ 

### Chap 3.2 VSCode(clangd)å®‰è£…

è®¿é—®å¾®è½¯VSCodeçš„å®˜ç½‘ï¼Œç›´æ¥ä¸‹è½½å¹¶å®‰è£…clangdå³å¯ã€‚

ä¸‹è½½ååªéœ€è¦æœ€å°‘å®‰è£…`clangd`å’Œ`xmake`ä¸¤ä¸ªæ’ä»¶å³å¯å¼€å§‹ç¼–å†™å’Œé˜…è§ˆé¡¹ç›®å•¦~

> note: VSCodeä¸­ä¸‹è½½xmakeæ’ä»¶ä¹‹åï¼Œéœ€è¦è¿›å…¥vscodeè®¾ç½®æ‰¾åˆ°`xmake.compileCommandsDirectory`è¿™ä¸ªé…ç½®å¹¶å°†å…¶å€¼è®¾ç½®ä¸º`build`ã€‚
>
> ä¹‹åå½“ä½ ä¸‹æ¬¡ä¿å­˜xmake.luaå·¥ç¨‹æ–‡ä»¶çš„æ—¶å€™ï¼Œxmakeæ’ä»¶å°†ä¼šè‡ªåŠ¨ç”Ÿæˆclangdæ‰€éœ€çš„æ•°æ®åº“æ–‡ä»¶å¹¶ä¿å­˜åˆ°`./build/compile_commands.json`ä¸­ã€‚

> note: é»˜è®¤æƒ…å†µä¸‹ï¼Œclangdå¯èƒ½æ— æ³•æ‰¾åˆ°æ ‡å‡†å¤´æ–‡ä»¶(ä¾‹å¦‚stdio.h)ï¼Œæ­¤æ—¶å¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º`.clangd`æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ :
>
> ```yaml
> CompileFlags:
>   Add: [
>     "-IC:/msys64/mingw64/arm-none-eabi/include/c++/13.2.1/arm-none-eabi/thumb/v7e-m+fp/hard",
>     "-IC:/msys64/mingw64/arm-none-eabi/include/c++/13.2.1",
>     "-IC:/msys64/mingw64/arm-none-eabi/include",
>   ]
>   Remove: []
> ```
>
> å…¶ä¸­`-IC:/msys64/`çš„è·¯å¾„æ˜¯ä½ Msys2çš„å®‰è£…ç›®å½•ï¼Œåé¢`include/c++/13.2.1/arm-none-eabi/thumb/v7e-m+fp/hard`çš„è·¯å¾„éœ€è¦æ ¹æ®ä½ ç°åœ¨ä½¿ç”¨çš„mcuçš„æŒ‡ä»¤é›†(`v7e-m+fp`)å’Œä½ æ‰€å®‰è£…çš„arm-none-eabi-gccç‰ˆæœ¬(`13.2.1`)å†³å®šã€‚
>
> ä½ å¯ä»¥é€šè¿‡è¿™ä¸¤ç§æ–¹æ³•ä¸­çš„ä¸€ç§:
>
> - ç›´æ¥æ‰“å¼€è¿™ä¸ªç›®å½•`<ä½ MSYS2çš„å®‰è£…ç›®å½•>/mingw64/arm-none-eabi/include/c++/`
> - è¾“å…¥`arm-none-eabi-gcc --version`å‘½ä»¤
>
> æ¥å¿«é€Ÿç¡®å®šgccç‰ˆæœ¬ã€‚

#### Chap 3.2.1 xmake.lua

XMakeæ˜¯ä¸€ä¸ªç°ä»£çš„ã€å¿«é€Ÿçš„ã€ä¼˜é›…çš„è‡ªåŠ¨åŒ–æ„å»ºè½¯ä»¶ï¼Œä½†æ˜¯ç”±STM32CubeMXè‡ªåŠ¨ç”Ÿæˆçš„åµŒå…¥å¼å·¥ç¨‹é»˜è®¤ä½¿ç”¨Makefileï¼Œä¸ºäº†å‡å°‘æ‰‹åŠ¨é…ç½®å·¥ç¨‹è¿™ç§å†—æ‚çš„å·¥ä½œï¼Œæˆ‘ä½¿ç”¨luaç¼–å†™äº†ä¸€ä¸ªç®€é™‹ä½†æ˜¯å‹‰å¼º"Good Enough"çš„Makefileè§£æå™¨ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨è§£æSTM32CubeMXè‡ªåŠ¨ç”Ÿæˆçš„Makefileæ–‡ä»¶ä¸­çš„æ‰€åˆ—å‡ºçš„ç¼–è¯‘é“¾æ¥å‚æ•°ã€å¤´å’Œæºæ–‡ä»¶è·¯å¾„ç­‰ä¸»è¦å‚æ•°ï¼Œå¹¶åŠ è½½åˆ°xmakeå·¥ç¨‹ä¸­ã€‚

xmake.luaå¦‚ä¸‹:

```lua
add_rules("mode.debug", "mode.release")
set_allowedarchs("arm")
set_defaultarchs("arm")
set_allowedplats("cross")
set_defaultplat("cross")

toolchain("auto_detected_from_makefile_toolchain")
  set_kind("standalone")
  set_description("Auto detected toolchain from Makefile")
  on_load(function (toolchain)

    local makefile_table = {}
    import("makefile_luaparser.parser")
    makefile_table = parser("./mcu/Makefile")

    toolchain:set("toolset", "cc", makefile_table["CC"])
    toolchain:set("toolset", "ld", makefile_table["LD"])
    toolchain:set("toolset", "as", makefile_table["CC"])
    toolchain:set("toolset", "sh", makefile_table["CC"])
    toolchain:set("toolset", "ar", makefile_table["CC"])

    toolchain:add("asflags",makefile_table["ASFLAGS"])
    toolchain:add("cxflags",makefile_table["CFLAGS"])
    toolchain:add("ldflags",makefile_table["LDFLAGS"])

    -- for k, v in pairs(makefile_table) do
    -- print("xmake.parser " .. k .. "\t\t:\t" .. v)
    -- end

    toolchain:set("toolset", "cxx", "arm-none-eabi-g++")
    toolchain:add("cxxflags", makefile_table["CFLAGS"] .. " -std=c++17")

    print(toolchain:get("cxflags"))

    print("xmake.parser: toolchain loaded")
  end)

toolchain_end()

-- to compile the project, you need to configure as:
-- > xmake f
-- and then build the project as:
-- > xmake
target("demo-proj.elf", function (target) 
  set_toolchains("auto_detected_from_makefile_toolchain")
  set_kind("binary")
  add_files("App/Src/*.c")
  add_includedirs("App/Inc")
  set_default(true)

  set_optimize("none")

  local makefile_table = {} 
  on_load(function (target)
    -- add source files & include directories from makefile
    import("makefile_luaparser.parser")
    makefile_table = parser("./mcu/Makefile")
    for file in makefile_table["C_INCLUDES"]:gmatch("[^%s]+") do
      target:add("cincludes", file)
    end
    for file in makefile_table["AS_INCLUDES"]:gmatch("[^%s]+") do
      target:add("includedirs", file)
    end
    for file in makefile_table["LIBDIR"]:gmatch("[^%s]+") do
      target:add("linkdirs", file)
    end

    for file in makefile_table["C_SOURCES"]:gmatch("[^%s]+") do
      target:add("files", file, {rule = "c"})
    end
    for file in makefile_table["ASM_SOURCES"]:gmatch("[^%s]+") do
      target:add("files", file, {rule = "asm"})
    end
  end);


  -- generate the hex;bin file
  after_build(function (target)
    os.exec(makefile_table["HEX"] .. " " .. target:targetfile() .. " " .. target:targetfile():match("(.*).elf") .. ".hex")
    os.exec(makefile_table["BIN"] .. " " .. target:targetfile() .. " " .. target:targetfile():match("(.*).elf") .. ".bin")
    os.exec(makefile_table["SZ"] .. " " .. target:targetfile())
  end)

  -- flash the target using os.exec command
  on_run(function (target)
    -- copy the target to ./target/target.elf
    os.cp(target:targetfile(), "./target/target.elf")
    -- os.cp(target:targetfile():match("(.*).bin"), "./target/target.bin")

    local command = "openocd -f openocd.cfg -c \"program " .. target:targetfile():match("(.*).elf") .. ".hex\" " .. "-c \"reset run\" -c \"exit\""
    print("flush the target: %s", target:targetfile() .. " with argument:\n\t" .. command)
    os.exec(command)
  end)

end)
target_end()
```

å…¶ä¸­å¼•å…¥çš„`makefile_luaparser.parser`å¯ä»¥åœ¨æˆ‘çš„å¼€æºä»“åº“ä¸­ä¸‹è½½åˆ°: [MakefileLUAParser](https://github.com/nmpassthf/MakefileLUAParser)

ä¸»è¦ä¿®æ”¹çš„éƒ¨åˆ†ä¸º:

- æŒ‡å®šäº†ä¸€ä¸ªåä¸º`auto_detected_from_makefile_toolchain`çš„toolchain
- è®¾ç½®é»˜è®¤çš„target.elfçš„toolchainä¸º`auto_detected_from_makefile_toolchain`
- åœ¨`on_load()`ä¸­åŠ è½½makefile_tableä¸­çš„ä¸€ç³»åˆ—æºæ–‡ä»¶å’Œå¯¼å…¥ç›®å½•
- åœ¨`after_build()`ä¸­ä½¿ç”¨HEXã€BINã€SZç”Ÿæˆå¯¹åº”çš„hexã€binæ–‡ä»¶å¹¶æ‰“å°elfçš„size
- åœ¨`on_run()`ä¸­è°ƒç”¨openocdè¯»å–æ ¹ç›®å½•ä¸‹çš„`openocd.cfg`é…ç½®æ–‡ä»¶ï¼Œä»¥å®ç°è‡ªåŠ¨çƒ§å½•ç¨‹åºåˆ°å•ç‰‡æœºä¸­

å¦‚æœåªæ˜¯æ‹¿æ¥ç”¨çš„è¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç¤ºä¾‹ä¸­çš„å·¥ç¨‹ï¼Œç›´æ¥æ‰“å¼€å…¶ä¸­çš„`./mcu/mcu.ioc`ä¿®æ”¹ä¸ºä½ æ‰€éœ€çš„MCUï¼Œç„¶åè®©STM32CubeMXé‡æ–°ç”ŸæˆMakefileå³å¯ã€‚

#### Chap 3.2.2 å·¥ç¨‹ç»“æ„

ç¤ºä¾‹å·¥ç¨‹ä¸­ä¸»è¦ç»“æ„å¦‚ä¸‹:

```
. # å·¥ç¨‹æ ¹ç›®å½•, åŒ…å«xmake.luaã€openocd.cfgé…ç½®æ–‡ä»¶ã€SVD.svd(é€‚é…ä½ MCUçš„svdæ–‡ä»¶ï¼Œç”¨äºgdbè°ƒè¯•å¯„å­˜å™¨)
â”œâ”€App
â”‚  â”œâ”€Inc # åº”ç”¨å±‚å¤´æ–‡ä»¶(*.h/*.hpp)
â”‚  â””â”€Src # åº”ç”¨å±‚æºæ–‡ä»¶(*.c/*.cpp)
â”œâ”€build #ç¼–è¯‘ä¸´æ—¶æ–‡ä»¶
â”‚  â””â”€cross
â”‚      â””â”€arm
â”‚          â””â”€debug # debugæ¨¡å¼ä¸‹è¾“å‡ºçš„æ–‡ä»¶ç›®å½•
|          â””â”€release # releaseæ¨¡å¼ä¸‹è¾“å‡ºçš„æ–‡ä»¶ç›®å½•
â”œâ”€makefile_luaparser # æˆ‘ç¼–å†™çš„LUAMakefileè§£æå™¨ç›®å½•
â”œâ”€mcu # æ­¤æ–‡ä»¶å¤¹æ˜¯STM32CubeMXçš„Makefileå·¥ç¨‹æ ¹ç›®å½•, åŒ…å«Makefileå’Œmcu.iocç­‰æ–‡ä»¶
â”‚  â”œâ”€Core
â”‚  â”‚  â”œâ”€Inc # STM32CubeMXè‡ªåŠ¨ç”Ÿæˆçš„å¤´æ–‡ä»¶(*.h)
â”‚  â”‚  â””â”€Src # STM32CubeMXè‡ªåŠ¨ç”Ÿæˆçš„æºæ–‡ä»¶(*.c)
â”‚  â”œâ”€Drivers
â”‚  â”‚  â”œâ”€CMSIS
â”‚  â”‚  â”‚  â”œâ”€Device # STM32CubeMXè‡ªåŠ¨ä¸‹è½½çš„CMSISåº“æ–‡ä»¶
â”‚  â”‚  â”‚  â”‚  â””â”€ST
â”‚  â”‚  â”‚  â”‚      â””â”€STM32G4xx
â”‚  â”‚  â”‚  â”‚          â”œâ”€Include
â”‚  â”‚  â”‚  â”‚          â””â”€Source
â”‚  â”‚  â”‚  â”‚              â””â”€Templates
â”‚  â”‚  â”‚  â””â”€Include
â”‚  â”‚  â””â”€STM32G4xx_HAL_Driver # STæä¾›çš„HALåº“
â”‚  â”‚      â”œâ”€Inc
â”‚  â”‚      â”‚  â””â”€Legacy
â”‚  â”‚      â””â”€Src
â”‚  â””â”€Middlewares # STæä¾›çš„ä¸­é—´ä»¶åº“(è¿™é‡Œç”¨DSPåº“ä¸¾ä¾‹)
â”‚      â””â”€ST
â”‚          â””â”€ARM
â”‚              â””â”€DSP
â”‚                  â”œâ”€Inc
â”‚                  â””â”€Lib
â””â”€target # ä»buildæ–‡ä»¶å¤¹ä¸­è‡ªåŠ¨å¤åˆ¶å‡ºæ¥çš„target.elf
```

å› æ­¤ï¼Œå½“ä½ å°è¯•åˆ‡æ¢MCUçš„æ—¶å€™ï¼Œåªéœ€è¦æ›¿æ¢ç›®å½•ä¸‹æ•´ä¸ª`./mcu/`æ–‡ä»¶å¤¹ï¼Œç„¶åä¿®æ”¹openocd.cfgé€‚é…æ–°å¼€å‘æ¿å¹¶ä¸‹è½½å¯¹åº”çš„svdæ–‡ä»¶å³å¯ï¼Œæ— éœ€å†åšå¤§è§„æ¨¡å˜åŠ¨ã€‚

## Chap 4 ä½¿ç”¨GNU make + Microsoft C/C++ IntelliSense

*ç« èŠ‚æç¤º: Chap 3 å’Œ Chap 4é€‰æ‹©å…¶ä¸€å³å¯*

### Chap 4.1 GNU makeå®‰è£…

`pacman -S mingw-w64-x86_64-make`

### Chap 4.2 VSCode(ms IntelliSense)å®‰è£…

ä¸[Chap 3.2](#chap-32-vscodeclangdå®‰è£…)ç±»ä¼¼ï¼Œåªæ˜¯éœ€è¦å®‰è£…çš„æ’ä»¶æ›´æ¢ä¸º

- å¾®è½¯æä¾›çš„C/C++æ’ä»¶
- Makefileæ’ä»¶

ç„¶ååœ¨C/C++æ’ä»¶ä¸­é…ç½®Include Pathåˆ°`<ä½ MSYS2çš„å®‰è£…ç›®å½•>/mingw64/arm-none-eabi/include/*`å³å¯ã€‚